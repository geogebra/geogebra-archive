<?xml version="1.0" encoding="ISO-8859-1" ?>

<!-- README: Building GeoGebra 

This script builds several kinds of GeoGebra *.jar files,
primarily for creating an official build for GeoGebra.
It must be run using JDK 1.5 (NOT 1.6 or later).
Note that GeoGebra itself needs to be compiled using Java 1.5.

To learn more on building GeoGebra by using this script, please
read the following web pages:

  http://www.geogebra.org/trac/wiki/SetUpCommandLine
  http://www.geogebra.org/trac/wiki/BuildingProcess

If you want to include GeoGebra with e.g. Linux distributions or
other software, please see the license conditions below and contact
us at office@geogebra.org. We will try our best to provide installers
for various platforms. However, we cannot provide our signature files
to create signed *.jar files.

LICENSE
Please note that GeoGebra's source code is licensed under GNU GPL but
all GeoGebra language files (geogebra/properties) bundled in the file
geogebra_properties.jar are subject to a Creative Commons Attribution-
Share Alike license (see LICENSE.txt).

If you would like to contribute to GeoGebra in any way, please let us
know. Your help is always welcome!

The GeoGebra Team
office@geogebra.org 
-->

<!--
   GeoGebra build script
   @author Markus Hohenwarter <markus@geogebra.org>
-->

<project default="geogebra">

	<import file="common.xml"/>
	
	<!-- build signed and unsigned GeoGebra jar files -->
	<target name="geogebra" 
		depends="clean, ggb-jar-files, copyDebug, signDebug, obfuscate, delete3D, ggb-jar-index, 
					copyJars, sign, pack, preloadHtml, finish">
	</target>

	<!-- build signed and unsigned GeoGebra 3D jar files -->
	<target name="geogebra3D" 
		depends="clean, ggb-jar-files3D, copyDebug3D, signDebug, obfuscate3D, ggb-jar-index3D, 
					copyJars3D, sign, pack, preloadHtml, finish">
	</target>

	<!-- build signed and unsigned GeoGebra jar files (from command line) -->
	<target name="geogebra-cl"
		depends="clean, compile-grammar-cl, compile-oe-cl, geogebra">
	</target>

	<!-- build signed and unsigned GeoGebra 3D jar files (from command line) -->
	<target name="geogebra3D-cl"
		depends="clean, compile-grammar-cl, compile-oe-cl, geogebra3D">
	</target>

	<!-- build jar files for testing without obfuscation -->
	<target name="geogebra-unobfuscated" 
		depends="clean, ggb-jar-files, delete3D, ggb-jar-index, 
					copyJars, sign, pack, preloadHtml, finish">
	</target>

	<!-- build jar files for testing without obfuscation -->
	<target name="geogebra3D-unobfuscated" 
		depends="clean, ggb-jar-files3D, 
					copyJars3D, sign, pack, preloadHtml, finish">
	</target>

	<!-- create all jar files -->
	<target name="ggb-jar-files" 
			depends="ggb-jar, ggb-main-jar, ggb-export-jar, ggb-properties-jar, ggb-cas-jar, ggb-algos-jar, ggb-gui-jar, ggb-javascript-jar, ggb-3d-jar, ggb-usb-jar, ggb-copy-jlatexmath">
	</target>

	<!-- compiles grammar, javacc path is hardcoded now for simplicity -->
	<target name="compile-grammar">
		<javacc
		   target="./geogebra/kernel/parser/Parser.jj"
		   javacchome="${src.dir}/lib/build/javacc"
		   static="false"
		/>
	</target>

	<target name="compile-oe">
		<mkdir dir="${build.dir}/classes" />
		<path id="build.class.path">
			<fileset dir="${src.dir}">
				<include name="*.jar" />
				<include name="lib/build/jogl1/jar/jogl.jar" />
				<include name="lib/build/jogl1/jar/gluegen-rt.jar" />
			</fileset>
		</path>
		<javac srcdir="${src.dir}" destdir="${build.dir}/classes">
			<classpath refid="build.class.path" />
		<!-- Adding line numbers -->
		<compilerarg value="-g" />
		</javac>
	</target>

	<!-- compiles grammar for cl -->
	<target name="compile-grammar-cl" depends="compile-grammar-clean, compile-grammar">
	</target>

	<target name="compile-grammar-clean">
		<delete followsymlinks="false">
			<fileset dir="./geogebra/kernel" includes="**/*.class" />
		</delete>
		<delete followsymlinks="false">
			<fileset dir="./geogebra/kernel/parser" includes="*.java"/>
		</delete>
	</target>

	<target name="delete-sources">
		<delete followsymlinks="false">
			<fileset dir="." includes="**/*.java" />
		</delete>
		<delete followsymlinks="false">
			<fileset dir="." includes="geogebra/properties/*.properties" />
		</delete>
	</target>

	<target name="delete-classes">
		<delete followsymlinks="false">
			<fileset dir="." includes="**/*.class" />
		</delete>
	</target>

	<target name="compile-oe-cl">
		<path id="build.class.path">
			<fileset dir="${src.dir}">
				<include name="*.jar"/>
				<include name="lib/build/jogl1/jar/jogl.jar"/>
				<include name="lib/build/jogl1/jar/gluegen-rt.jar"/>
			</fileset>
		</path>
		<javac srcdir="${src.dir}">
			<classpath refid="build.class.path"/>
			<!-- Adding line numbers -->
			<compilerarg value="-g" />
		</javac>
	</target>

	<!-- create all jar files -->
	<target name="ggb-jar-files3D" 
			depends="ggb-jar3D, ggb-main-jar, ggb-export-jar, ggb-properties-jar, ggb-cas-jar, ggb-algos-jar, ggb-gui-jar, ggb-javascript-jar, ggb-3d-jar, ggb-usb-jar, ggb-copy-jlatexmath, ggb-copy-jogl">
	</target>

	<manifest file="../manifest.mf">
		<attribute name="Main-Class" value="geogebra.GeoGebra"/>
		<attribute name="Class-Path" 
			value="geogebra.jar geogebra_main.jar geogebra_gui.jar geogebra_properties.jar geogebra_export.jar geogebra_cas.jar geogebra_algos.jar geogebra_javascript.jar geogebra_usb.jar jlatexmath.jar jlm_greek.jar jlm_cyrillic.jar"/>
		<!--	<attribute name="SplashScreen-Image" value="geogebra/splash.gif"/>	-->
	</manifest>

	<manifest file="../manifest3D.mf">
		<attribute name="Main-Class" value="geogebra.GeoGebra3D"/>
		<attribute name="Class-Path" 
			value="geogebra.jar geogebra_main.jar geogebra_gui.jar geogebra_properties.jar geogebra_export.jar geogebra_cas.jar geogebra_algos.jar geogebra_3d.jar geogebra_javascript.jar geogebra_usb.jar jlatexmath.jar jlm_greek.jar jlm_cyrillic.jar jogl.jar gluegen-rt.jar"/>
		<!--	<attribute name="SplashScreen-Image" value="geogebra/splash.gif"/>	-->
	</manifest>

	<target name="clean">
		<!-- delete build directory -->
		<mkdir dir="${build.dir}"/>
		<delete includeemptydirs="true" followsymlinks="false">
			<fileset dir="${build.dir}" defaultexcludes="false">
				<include name="**/*" />
			</fileset>
		</delete>

		<mkdir dir="${build.dir}"/>
		<mkdir dir="${build.dir}/packed"/>
		<mkdir dir="${build.dir}/unpacked"/>
		<mkdir dir="${build.dir}/unsigned"/>
		<mkdir dir="${build.dir}/debug"/>
		<mkdir dir="${build.dir}/unsigned/packed"/>
		<mkdir dir="${build.dir}/unsigned/unpacked"/>
		<mkdir dir="${propertiestemp.dir}"/>
	</target>

	<target name="delete3D">
		<!-- delete build directory -->
		<mkdir dir="${build.dir}"/>
		<delete includeemptydirs="true" followsymlinks="false">
			<fileset dir="${build.dir}" defaultexcludes="false">
				<include name="**/geogebra_3d.jar" />
			</fileset>
		</delete>

	</target>

	<target name="finish">
		<delete dir="${propertiestemp.dir}"/>
	</target>

	<!-- remove comments from properties files -->
	<target name="stripComments">
		<copy todir="${propertiestemp.dir}/geogebra/properties" encoding="ISO-8859-1">
			<fileset dir="${propertiessrc.dir}">
				<include name="*" />
			</fileset>
			<filterchain>
				<trim/>
				<striplinecomments>
					<comment value="#"/>
				</striplinecomments>
			</filterchain>
		</copy>
	</target>

	<!-- put jar files into subdirectories signed and unsigned -->
	<target name="copyJars" depends="ggb-jar-files">
		<copy todir="${build.dir}/unsigned/unpacked">
			<fileset dir="${build.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<!-- put jar files (unobfuscated, unindexed) into subdirectory debug -->
	<target name="copyDebug" depends="ggb-jar-files">
		<copy todir="${build.dir}/debug">
			<fileset dir="${build.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<!-- put jar files (unobfuscated, unindexed) into subdirectory debug -->
	<target name="copyDebug3D" depends="ggb-jar-files3D">
		<copy todir="${build.dir}/debug">
			<fileset dir="${build.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<!-- put jar files into subdirectories signed and unsigned -->
	<target name="copyJars3D" depends="ggb-jar-files3D">
		<copy todir="${build.dir}/unsigned/unpacked">
			<fileset dir="${build.dir}">
				<include name="*.jar" />
			</fileset>
		</copy>
	</target>

	<!-- geogebra.jar loads the geogebra_main.jar file and starts up the application/applet  -->
	<target name="ggb-jar" depends="clean" description="create unsigned geogebra.jar">
		<jar jarfile="${build.dir}/geogebra.jar" manifest="../manifest.mf" >
			<fileset dir="${src.dir}"		   
				includes="geogebra/*"			
				excludes="**/*.java"/>
		</jar>
	</target>

	<!-- geogebra.jar loads the geogebra_main.jar file and starts up the application/applet  -->
	<target name="ggb-jar3D" depends="clean" description="create unsigned geogebra.jar">
		<jar jarfile="${build.dir}/geogebra.jar" manifest="../manifest3D.mf" >
			<fileset dir="${src.dir}"		   
				includes="geogebra/*"			
				excludes="**/*.java"/>
		</jar>
	</target>

	<!-- create index.list in geogebra.jar for optimized loading of other jars by Java classloader -->
	<target name="ggb-jar-index" depends="ggb-jar-files" description="create index in geogegebra.jar">
		<exec executable="jar" dir="${build.dir}">
			<arg value="i"/>
			<arg value="geogebra.jar"/>
			<arg value="geogebra_main.jar"/>
			<arg value="geogebra_gui.jar"/>
			<arg value="geogebra_cas.jar"/>
			<arg value="geogebra_algos.jar"/>
			<arg value="geogebra_export.jar"/>
			<arg value="geogebra_javascript.jar"/>
			<arg value="geogebra_properties.jar"/>
			<arg value="geogebra_usb.jar"/>
			<arg value="jlatexmath.jar"/>
			<arg value="jlm_cyrillic.jar"/>
			<arg value="jlm_greek.jar"/>
		</exec>
	</target>
	<!-- copies the jogl jars  -->
	<target name="ggb-copy-jogl" depends="clean" description="copy jogl jars">
		<copy file="${src.dir}/lib/build/jogl1/jar/jogl.jar"
		      tofile="${build.dir}/jogl.jar">
		</copy>
		<copy file="${src.dir}/lib/build/jogl1/jar/gluegen-rt.jar"
		      tofile="${build.dir}/gluegen-rt.jar">
		</copy>
	</target>

	<!-- copies the jlatexmath jars  -->
	<target name="ggb-copy-jlatexmath" depends="clean" description="copy jlatexmath jars">
		<copy file="${src.dir}/lib/jlatexmath.jar"
		      tofile="${build.dir}/jlatexmath.jar">
		</copy>
		<copy file="${src.dir}/lib/jlm_greek.jar"
		      tofile="${build.dir}/jlm_greek.jar">
		</copy>
		<copy file="${src.dir}/lib/jlm_cyrillic.jar"
		      tofile="${build.dir}/jlm_cyrillic.jar">
		</copy>
	</target>

	<!-- create index.list in geogebra.jar for optimized loading of other jars by Java classloader -->
	<target name="ggb-jar-index3D" depends="ggb-jar-files3D" description="create index in geogegebra.jar">
		<exec executable="jar" dir="${build.dir}">
			<arg value="i"/>
			<arg value="geogebra.jar"/>
			<arg value="geogebra_main.jar"/>
			<arg value="geogebra_gui.jar"/>
			<arg value="geogebra_cas.jar"/>
			<arg value="geogebra_algos.jar"/>
			<arg value="geogebra_3d.jar"/>
			<arg value="geogebra_export.jar"/>
			<arg value="geogebra_javascript.jar"/>
			<arg value="geogebra_properties.jar"/>
			<arg value="geogebra_usb.jar"/>
			<arg value="geogebra_jogl.jar"/>
			<arg value="geogebra_gluegen-rt.jar"/>
			<arg value="jlatexmath.jar"/>
			<arg value="jlm_cyrillic.jar"/>
			<arg value="jlm_greek.jar"/>
		</exec>
	</target>


	<!-- geogebra_main.jar includes all basic classes to run the application and applet  -->
	<target name="ggb-main-jar" depends="clean" description="create unsigned geogebra_main.jar">
		<jar jarfile="${build.dir}/geogebra_main.jar"		
			basedir="${src.dir}"		   
			includes="**/*.class,	
		  			geogebra/main/default-preferences.xml, 				
					  geogebra/main/*.png,
			  edu/xtec/adapter/**,
			  edu/xtec/adapter/impl/**,
					  **/algo2command.properties,	
					  **/algo2intergeo.properties"			
			excludes="geogebra/*,
					geogebra/gui/**,
					geogebra/export/**, 
					geogebra/cas/**,
			geogebra/kernel/discrete/**,
			geogebra/kernel/cas/**,
			geogebra/sound/**,
					jasymca/**,		
					geogebra3D/**,			
					3D/**,	
					org/**,
					org/mathpiper/**,
					org/mozilla/**,
					org/freehep/**, 
					org/concord/**,
					ccsd/**,
					geogebra/usb/**,
					edu/mas/**,
					edu/jas/**,
					edu/uci/**,
					org/apache/**,
					org/apache/log4j/**, 
			com/bric/**,
				    tutor/**,
					meta-inf/**"		
		/>
	</target>

	<target name="ggb-export-jar" depends="clean" description="create unsigned geogebra_export.jar">
		<jar jarfile="${build.dir}/geogebra_export.jar"
			basedir="${src.dir}"
			includes="geogebra/export/**, 
					org/freehep/**, 
					meta-inf/services/**"
			excludes="**/*.java,
			**/*.html" 
		/>
	</target>

	<target name="ggb-usb-jar" depends="clean" description="create unsigned geogebra_usb.jar">
		<jar jarfile="${build.dir}/geogebra_usb.jar"
			basedir="${src.dir}"
			includes="org/concord/**,
						ccsd/**,
			geogebra/usb/**"
			excludes="**/*.java" 
		/>
	</target>

	<target name="ggb-javascript-jar" depends="clean" description="create unsigned geogebra_javascript.jar">
		<jar jarfile="${build.dir}/geogebra_javascript.jar"
			basedir="${src.dir}"
			includes="org/mozilla/**"
			excludes="**/*.java" 
		/>
	</target>

	<target name="ggb-cas-jar" depends="clean" description="create unsigned geogebra_cas.jar">
		<jar jarfile="${build.dir}/geogebra_cas.jar"
			basedir="${src.dir}"
			includes="geogebra/cas/**,
					org/apache/log4j/**,
					org/mathpiper/mpreduce/**,
			geogebra/kernel/cas/**,
					default.img"
			excludes="**/*.java,
			geogebra/cas/maxima/**,
			geogebra/cas/jacomax/**,
			geogebra/cas/mathpiper/**" 
		/>
	</target>

	<target name="ggb-algos-jar" depends="clean" description="create unsigned geogebra_algos.jar">
		<jar jarfile="${build.dir}/geogebra_algos.jar"
			basedir="${src.dir}"
			includes="geogebra/kernel/discrete/**,
			geogebra/sound/**,
					edu/uci/**,
					org/jfugue/**,
					org/apache/**"
			excludes="**/*.java,
			**/*.html,
			**/*.txt,
			org/apache/log4j/**" 
		/>
	</target>

	<target name="ggb-gui-jar" depends="clean" description="create unsigned geogebra_gui.jar">
		<jar jarfile="${build.dir}/geogebra_gui.jar"
			basedir="${src.dir}"
			includes="geogebra/gui/**"
			excludes="**/*.java" 
		/>
	</target>

	<target name="ggb-3d-jar" depends="clean" description="create unsigned geogebra_3d.jar">
		<jar jarfile="${build.dir}/geogebra_3d.jar"
			basedir="${src.dir}"
			includes="geogebra3D/**"		
			excludes="**/*.java,
						geogebra3D/samples/**" 
		/>
	</target>

	<target name="ggb-properties-jar" depends="clean, stripComments" description="create unsigned geogebra_properties.jar">
		<jar jarfile="${build.dir}/geogebra_properties.jar"
			basedir="${propertiestemp.dir}"
			includes="**/*"		
			excludes="**/wiki*.*"
		/>
	</target>


	<!-- Define Proguard task -->
	<taskdef 
		resource="proguard/ant/task.properties" 
		classpath="lib/build/tools_proguard46.jar" />

	<!-- Define pack200 task -->
	<!-- bug in Java 6, see http://www.geogebra.org/forum/viewtopic.php?f=8&t=3972&st=0&sk=t&sd=a&start=15 -->
	<taskdef name="p200ant"
	    classname="de.matthiasmann.p200ant.P200AntTask"
	    classpath="lib/build/tools_p200ant_java5only.jar"/>


	<!-- Obfuscate jar files without signing -->
	<target name="obfuscate" depends="ggb-jar-files">
		<!-- check if java150-rt.jar file present -->
		<condition property="java150-rt.present">
			<available file="${workspace.dir}/java150-rt.jar"/>
		</condition>
		<antcall target="doObfuscate"/>
	</target>
	<target name="obfuscate3D" depends="ggb-jar-files3D">
		<!-- check if java150-rt.jar file present -->
		<condition property="java150-rt.present">
			<available file="${workspace.dir}/java150-rt.jar"/>
		</condition>
		<antcall target="doObfuscate"/>
	</target>
	<target name="doObfuscate" if="java150-rt.present" description="obfuscate jar files">
		<proguard configuration="build.pro"/>
		<move todir="${build.dir}">
			<fileset dir="${temp.dir}">
				<include name="*.jar"/>
			</fileset>
		</move>
		<delete dir="${temp.dir}"/>
	</target>

	<!-- Sign jar files -->
	<target name="sign" description="repack and sign jar files twice (to ensure WebStart compatibility)">
		<!-- check if keystore file present -->
		<condition property="keystore.present">
			<available file="${workspace.dir}/igi-keystore.p12"/>
		</condition>

		<!-- repack and sign jars first time -->
		<antcall target="repack"/>
		<antcall target="doSign"/>

		<!-- used to use to repack and sign jars second time -->
		<!-- not needed  due to pack.segment.limit=-1 works properly -->
		<!--antcall target="repack"/-->
		<!--antcall target="doSign"/-->
	</target>

	<!-- sign jars -->
	<target name="doSign" if="keystore.present" description="sign jar files">
		<signjar 
			keystore="${workspace.dir}/igi-keystore.p12" 	
			alias="International GeoGebra Institute&apos;s GlobalSign nv-sa ID"
			storetype="pkcs12"
			storepass="geogebra">
			<fileset dir="${build.dir}" includes="*.jar" />
		</signjar>
	</target>

	<!-- Sign debug jar files -->
	<target name="signDebug" description="repack and sign jar files twice (to ensure WebStart compatibility)">
		<!-- check if keystore file present -->
		<condition property="keystore.present">
			<available file="${workspace.dir}/igi-keystore.p12"/>
		</condition>

		<antcall target="doSignDebug"/>

	</target>

	<!-- sign debug jars -->
	<target name="doSignDebug" if="keystore.present" description="sign jar files">
		<signjar 
			keystore="${workspace.dir}/igi-keystore.p12" 	
			alias="International GeoGebra Institute&apos;s GlobalSign nv-sa ID"
			storetype="pkcs12"
			storepass="geogebra">
			<fileset dir="${build.dir}/debug" includes="*.jar" />
		</signjar>
	</target>

	<!-- repack jars -->
	<target name="repack" if="keystore.present" description="repack jar files in preparation for signing">
                <fileset id="jars2pack" dir="${build.dir}">
                        <include name="*.jar"/>
                </fileset>
                <p200ant repack="true"  configFile="tools_p200.config">
                        <fileset refid="jars2pack"/>
                </p200ant>
	</target>

	<!-- pack jars -->
	<!-- This should prevent running the pack target on Java 1.6
	     http://www.java-tips.org/other-api-tips/ant/how-can-i-test-for-jvm-versions.html -->
  	<target name="get-jvm">
      		<condition property="jvm.buggy">
			<or>
      				<equals arg1="${ant.java.version}" arg2="1.6"/>
      			</or>
      		</condition>
      	</target>

	<target name="pack" description="pack jar files" depends="get-jvm" unless="jvm.buggy">
                <fileset id="unsignedJars" dir="${build.dir}/unsigned/unpacked">
                        <include name="*.jar"/>
                </fileset>
                <p200ant destdir="${build.dir}/unsigned/packed"  configFile="tools_p200.config">
                        <fileset refid="unsignedJars"/>
                </p200ant>

		<move todir="${build.dir}/unpacked">
			<fileset dir="${build.dir}">
				<include name="*.jar" />
			</fileset>
		</move>

                <fileset id="signedJars" dir="${build.dir}/unpacked">
                        <include name="*.jar"/>
                </fileset>
                <p200ant destdir="${build.dir}/packed"  configFile="tools_p200.config">
                        <fileset refid="signedJars"/>
                </p200ant>

	</target>

	<!-- creates preload.html -->
	<target name="preloadHtml" depends="readVersion">
		<echo file="${build.dir}/unsigned/preload.html" append="false">
		&lt;html&gt;
		&lt;applet code="geogebra.GeoGebraAppletPreloader" archive="geogebra.jar" codebase="./" width="1" height="1"&gt;
			&lt;param name="cache_archive" value="geogebra.jar, geogebra_main.jar, geogebra_gui.jar, geogebra_cas.jar, geogebra_export.jar, geogebra_algos.jar, geogebra_javascript.jar, geogebra_properties.jar, jlatexmath.jar, jlm_cyrillic.jar, jlm_greek.jar "/&gt;
			&lt;param name="cache_version" value="${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}, ${fullversion}"/&gt;
		&lt;/applet&gt;
		&lt;/html&gt;	
		</echo>		
		
		<echo file="${build.dir}/unpacked/version.txt" append="false">${fullversion}</echo>
	</target>

</project>
