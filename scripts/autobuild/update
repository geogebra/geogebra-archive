#!/bin/sh
# Updates GeoGebra from SVN repository
# @author Zoltan Kovacs <zoltan@geogebra.org>

test -r autobuild.conf || {
 echo "Cannot find autobuild.conf (make sure you edit autobuild.conf.dist first)"
 exit 1
 }
. ./autobuild.conf
cd $SVNDIR/geogebra

if [ "$1" != "--no-update" ]; then
    $SVN_COMMAND update --accept theirs-full | tail -1 | grep ^At && exit 1 # No updates found.
    fi

export JAVA_HOME
export ANT_OPTS="-Xmx1024m"

# alias signjar=jarsigner # May be needed for ant version < 1.8.0 (the "executable" attribute is not supported yet).

ant -f build.xml geogebra-cl
cd build
mkdir -p $WWWDIR

# Copying dynamically generated files (autobuild):
cp -R * $WWWDIR

# Copying static files:
cp -R $SVNDIR/geogebra/webstart/4.0/* $WWWDIR

# Moving *.html and *.jnlp to unpacked/ and rewriting static URLs:
# http://www.geogebra.org/webstart/4.0/unsigned -> http://www.geogebra.org/webstart/test40a/unsigned
# http://www.geogebra.org/webstart/4.0/usb-gomotion.ggb -> http://www.geogebra.org/webstart/test40/usb-gomotion.ggb
# http://www.geogebra.org/webstart/4.0/debug -> http://www.geogebra.org/webstart/test40/debug
# http://www.geogebra.org/webstart/4.0/ -> http://www.geogebra.org/webstart/test40/unpacked/
# </title> -> (autobuild) </title>

cd $WWWDIR
for i in *.html *.jnlp; do
    cat $i | \
     sed s/"http:\/\/www.geogebra.org\/webstart\/4.0\/unsigned"/"http:\/\/www.geogebra.org\/webstart\/test40a\/unsigned"/g \
     sed s/"http:\/\/www.geogebra.org\/webstart\/4.0\/usb-gomotion"/"http:\/\/www.geogebra.org\/webstart\/test40a\/usb-gomotion.ggb"/g \
     sed s/"http:\/\/www.geogebra.org\/webstart\/4.0\/debug"/"http:\/\/www.geogebra.org\/webstart\/test40a\/debug"/g \
     sed s/"http:\/\/www.geogebra.org\/webstart\/4.0\/"/"http:\/\/www.geogebra.org\/webstart\/test40a\/unpacked"/g \
     sed s/"<\/title>"/"(autobuild) <\/title>"/g \
     > unpacked/$i
    rm $i
    done
